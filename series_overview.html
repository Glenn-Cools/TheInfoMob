<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
  <title>Series Overview</title>
<style>

#defaultText{
    position: relative;
    top: 100px;
    text-align: center;
    font: 30px sans-serif;
}

#vis{
    position: absolute;
    top: 50px;
    left: 20px;
}

#keySelector{
    position: fixed;
    left: 40px;
    background: white;
    z-index: 1
}

#info{
    position: fixed;
    left:20px;
    background:white;
    z-index:1;
}

#legend{
    position: fixed;
    z-index:1;
    left:20px;
    top:25px;
    background:white;
    border:solid;
    border-width: 0.5px;
    border-color: #b6b6b6;
    padding-right: 2px;
}

.axis {
    font: 10px sans-serif;
}

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

div.tooltip {   
    position: absolute;         
    text-align: center;
    color: white;
    height: auto;
    width: auto;                
    padding: 2px;               
    font: 12px sans-serif;
    border: 0px;        
    border-radius: 8px;         
    pointer-events: none;           
}

div.infotip {   
    position: absolute;         
    text-align: center;
    color: white;
    width: 570px;                
    padding: 2px;               
    font: 12px sans-serif;
    border: 0px;        
    border-radius: 8px;         
    pointer-events: none;
    z-index:2;           
}

.line {
    fill: none;
    stroke-width: 1.5px;
}

</style>
</head>

<body>
 
    <div id="defaultText" align="center">The data is being loaded.<br>Please wait.</div>
    <div id="smallMultiples1">
        <div id="info"></div>
        <div id="keySelector"></div>
        <div id="legend"></div>
        <div id="vis"></div>
    </div>

    

	<script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="js/lodash.min.js"></script>

	<script> 

    d3.csv("/TheInfoMob/Data/Definition and Source.csv", function(error, Series_Metadata){
        d3.csv("/TheInfoMob/Data/Country_Metadata.csv", function(error, Country_Metadata){
            d3.csv("/TheInfoMob/Data/Aggregate_Data.csv",function(d){

                    var parseDate = d3.time.format("%Y").parse;

                    return {
                        series_name : d["Series Name"],
                        series_code : d["Series Code"],
                        country_name : d["Country Name"],
                        country_code : d["Country Code"],
                        years : [
                        {year:parseDate("1960") ,"value": +d["1960 [YR1960]"]},
                        {year:parseDate("1961") ,"value": +d["1961 [YR1961]"]},
                        {year:parseDate("1962") ,"value": +d["1962 [YR1962]"]},
                        {year:parseDate("1963") ,"value": +d["1963 [YR1963]"]},
                        {year:parseDate("1964") ,"value": +d["1964 [YR1964]"]},
                        {year:parseDate("1965") ,"value": +d["1965 [YR1965]"]},
                        {year:parseDate("1966") ,"value": +d["1966 [YR1966]"]},
                        {year:parseDate("1967") ,"value": +d["1967 [YR1967]"]},
                        {year:parseDate("1968") ,"value": +d["1968 [YR1968]"]},
                        {year:parseDate("1969") ,"value": +d["1969 [YR1969]"]},
                        {year:parseDate("1970") ,"value": +d["1970 [YR1970]"]},
                        {year:parseDate("1971") ,"value": +d["1971 [YR1971]"]},
                        {year:parseDate("1972") ,"value": +d["1972 [YR1972]"]},
                        {year:parseDate("1973") ,"value": +d["1973 [YR1973]"]},
                        {year:parseDate("1974") ,"value": +d["1974 [YR1974]"]},
                        {year:parseDate("1975") ,"value": +d["1975 [YR1975]"]},
                        {year:parseDate("1976") ,"value": +d["1976 [YR1976]"]},
                        {year:parseDate("1977") ,"value": +d["1977 [YR1977]"]},
                        {year:parseDate("1978") ,"value": +d["1978 [YR1978]"]},
                        {year:parseDate("1979") ,"value": +d["1979 [YR1979]"]},
                        {year:parseDate("1980") ,"value": +d["1980 [YR1980]"]},
                        {year:parseDate("1981") ,"value": +d["1981 [YR1981]"]},
                        {year:parseDate("1982") ,"value": +d["1982 [YR1982]"]},
                        {year:parseDate("1983") ,"value": +d["1983 [YR1983]"]},
                        {year:parseDate("1984") ,"value": +d["1984 [YR1984]"]},
                        {year:parseDate("1985") ,"value": +d["1985 [YR1985]"]},
                        {year:parseDate("1986") ,"value": +d["1986 [YR1986]"]},
                        {year:parseDate("1987") ,"value": +d["1987 [YR1987]"]},
                        {year:parseDate("1988") ,"value": +d["1988 [YR1988]"]},
                        {year:parseDate("1989") ,"value": +d["1989 [YR1989]"]},
                        {year:parseDate("1990") ,"value": +d["1990 [YR1990]"]},
                        {year:parseDate("1991") ,"value": +d["1991 [YR1991]"]},
                        {year:parseDate("1992") ,"value": +d["1992 [YR1992]"]},
                        {year:parseDate("1993") ,"value": +d["1993 [YR1993]"]},
                        {year:parseDate("1994") ,"value": +d["1994 [YR1994]"]},
                        {year:parseDate("1995") ,"value": +d["1995 [YR1995]"]},
                        {year:parseDate("1996") ,"value": +d["1996 [YR1996]"]},
                        {year:parseDate("1997") ,"value": +d["1997 [YR1997]"]},
                        {year:parseDate("1998") ,"value": +d["1998 [YR1998]"]},
                        {year:parseDate("1999") ,"value": +d["1999 [YR1999]"]},
                        {year:parseDate("2000") ,"value": +d["2000 [YR2000]"]},
                        {year:parseDate("2001") ,"value": +d["2001 [YR2001]"]},
                        {year:parseDate("2002") ,"value": +d["2002 [YR2002]"]},
                        {year:parseDate("2003") ,"value": +d["2003 [YR2003]"]},
                        {year:parseDate("2004") ,"value": +d["2004 [YR2004]"]},
                        {year:parseDate("2005") ,"value": +d["2005 [YR2005]"]},
                        {year:parseDate("2006") ,"value": +d["2006 [YR2006]"]},
                        {year:parseDate("2007") ,"value": +d["2007 [YR2007]"]},
                        {year:parseDate("2008") ,"value": +d["2008 [YR2008]"]},
                        {year:parseDate("2009") ,"value": +d["2009 [YR2009]"]},
                        {year:parseDate("2010") ,"value": +d["2010 [YR2010]"]},
                        {year:parseDate("2011") ,"value": +d["2011 [YR2011]"]},
                        {year:parseDate("2012") ,"value": +d["2012 [YR2012]"]},
                        {year:parseDate("2013") ,"value": +d["2013 [YR2013]"]},
                        {year:parseDate("2014") ,"value": +d["2014 [YR2014]"]},
                        {year:parseDate("2015") ,"value": +d["2015 [YR2015]"]}
                        ]
                    }
                },function(Aggregate_Data){
                    d3.csv("/TheInfoMob/Data/Data.csv", function(d){

                        var parseDate = d3.time.format("%Y").parse;

                        return {
                            series_name : d["Series Name"],
                            series_code : d["Series Code"],
                            country_name : d["Country Name"],
                            country_code : d["Country Code"],
                            years : [
                            {year:parseDate("1960") ,"value": +d["1960 [YR1960]"]},
                            {year:parseDate("1961") ,"value": +d["1961 [YR1961]"]},
                            {year:parseDate("1962") ,"value": +d["1962 [YR1962]"]},
                            {year:parseDate("1963") ,"value": +d["1963 [YR1963]"]},
                            {year:parseDate("1964") ,"value": +d["1964 [YR1964]"]},
                            {year:parseDate("1965") ,"value": +d["1965 [YR1965]"]},
                            {year:parseDate("1966") ,"value": +d["1966 [YR1966]"]},
                            {year:parseDate("1967") ,"value": +d["1967 [YR1967]"]},
                            {year:parseDate("1968") ,"value": +d["1968 [YR1968]"]},
                            {year:parseDate("1969") ,"value": +d["1969 [YR1969]"]},
                            {year:parseDate("1970") ,"value": +d["1970 [YR1970]"]},
                            {year:parseDate("1971") ,"value": +d["1971 [YR1971]"]},
                            {year:parseDate("1972") ,"value": +d["1972 [YR1972]"]},
                            {year:parseDate("1973") ,"value": +d["1973 [YR1973]"]},
                            {year:parseDate("1974") ,"value": +d["1974 [YR1974]"]},
                            {year:parseDate("1975") ,"value": +d["1975 [YR1975]"]},
                            {year:parseDate("1976") ,"value": +d["1976 [YR1976]"]},
                            {year:parseDate("1977") ,"value": +d["1977 [YR1977]"]},
                            {year:parseDate("1978") ,"value": +d["1978 [YR1978]"]},
                            {year:parseDate("1979") ,"value": +d["1979 [YR1979]"]},
                            {year:parseDate("1980") ,"value": +d["1980 [YR1980]"]},
                            {year:parseDate("1981") ,"value": +d["1981 [YR1981]"]},
                            {year:parseDate("1982") ,"value": +d["1982 [YR1982]"]},
                            {year:parseDate("1983") ,"value": +d["1983 [YR1983]"]},
                            {year:parseDate("1984") ,"value": +d["1984 [YR1984]"]},
                            {year:parseDate("1985") ,"value": +d["1985 [YR1985]"]},
                            {year:parseDate("1986") ,"value": +d["1986 [YR1986]"]},
                            {year:parseDate("1987") ,"value": +d["1987 [YR1987]"]},
                            {year:parseDate("1988") ,"value": +d["1988 [YR1988]"]},
                            {year:parseDate("1989") ,"value": +d["1989 [YR1989]"]},
                            {year:parseDate("1990") ,"value": +d["1990 [YR1990]"]},
                            {year:parseDate("1991") ,"value": +d["1991 [YR1991]"]},
                            {year:parseDate("1992") ,"value": +d["1992 [YR1992]"]},
                            {year:parseDate("1993") ,"value": +d["1993 [YR1993]"]},
                            {year:parseDate("1994") ,"value": +d["1994 [YR1994]"]},
                            {year:parseDate("1995") ,"value": +d["1995 [YR1995]"]},
                            {year:parseDate("1996") ,"value": +d["1996 [YR1996]"]},
                            {year:parseDate("1997") ,"value": +d["1997 [YR1997]"]},
                            {year:parseDate("1998") ,"value": +d["1998 [YR1998]"]},
                            {year:parseDate("1999") ,"value": +d["1999 [YR1999]"]},
                            {year:parseDate("2000") ,"value": +d["2000 [YR2000]"]},
                            {year:parseDate("2001") ,"value": +d["2001 [YR2001]"]},
                            {year:parseDate("2002") ,"value": +d["2002 [YR2002]"]},
                            {year:parseDate("2003") ,"value": +d["2003 [YR2003]"]},
                            {year:parseDate("2004") ,"value": +d["2004 [YR2004]"]},
                            {year:parseDate("2005") ,"value": +d["2005 [YR2005]"]},
                            {year:parseDate("2006") ,"value": +d["2006 [YR2006]"]},
                            {year:parseDate("2007") ,"value": +d["2007 [YR2007]"]},
                            {year:parseDate("2008") ,"value": +d["2008 [YR2008]"]},
                            {year:parseDate("2009") ,"value": +d["2009 [YR2009]"]},
                            {year:parseDate("2010") ,"value": +d["2010 [YR2010]"]},
                            {year:parseDate("2011") ,"value": +d["2011 [YR2011]"]},
                            {year:parseDate("2012") ,"value": +d["2012 [YR2012]"]},
                            {year:parseDate("2013") ,"value": +d["2013 [YR2013]"]},
                            {year:parseDate("2014") ,"value": +d["2014 [YR2014]"]},
                            {year:parseDate("2015") ,"value": +d["2015 [YR2015]"]}
                            ]
                        }
                    },function(data){
                        
                        document.getElementById("defaultText").innerHTML = "";
                        // ALL CODE INVOLVING THIS DATA COMES HERE
                        createVisualisation(data,Country_Metadata,Aggregate_Data, Series_Metadata,"#smallMultiples1");
                
                })
            })
        })
    })

    function getDataCountry(dataset,country_code){
        var result =[];
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].country_code == country_code){
                result.push(dataset[i]);
            } 
        }
        return result;
    }

    function getDataSeries(dataset,series_code){
        var result =[];
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].series_code == series_code){
                result.push(dataset[i]);
            } 
        }
        return result;
    }

    function filterDataSeriesRegion(dataset,country_metadata,series_code,region_code){
        if(region_code == "WLD"){
            return dataset;
        }else{
            var result = [];
            for(var i=0;i<dataset.length;i++){
                if(getRegionCode(country_metadata,dataset[i].country_code)==region_code){
                    result.push(dataset[i])
                }
            }
            return result;
        }
    }

    function getLongDefinition(dataset,series_code){
        var result =[];
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].Code == series_code){
                result.push(dataset[i]);
            } 
        }
        return result;
    }

    function getAllCodes(dataset){

        var result = [];
        for(var i=0; i<(dataset.length);i++){
            if(dataset[i].country_code=="BEL"){
                result.push({series_name : dataset[i].series_name, series_code: dataset[i].series_code});
            }
        }

        return result;
    }

    function getAllRegions(dataset){

        var result = [];
        for(var i=0; i<(dataset.length);i++){
            if(dataset[i].series_code=="SP.POP.GROW"){
                result.push({region_name : dataset[i].country_name, region_code: dataset[i].country_code});
            }
        }

        return result;
    }

    function getRegionCode(country_metadata, country_code){
        for (var i=0; i<(country_metadata.length);i++){
            if (country_code==country_metadata[i].Country_Code){
                return country_metadata[i].Region_Code;
            }
        }
    }

    function getCountries(Country_Metadata, region){
        var result = [];

        for (var i=0; i<(Country_Metadata.length); i++){
            if (region==Country_Metadata[i].Region){
                result.push(Country_Metadata[i].CountryCode);
            }
        }
        return result;
    }

    function createVisualisation(dataset,country_metadata,aggregate_data,series_metadata,container){

        default_code = sessionStorage.getItem("series_code");

        if(default_code === null){
            default_code ="SP.POP.GROW";
            sessionStorage.setItem("series_code","SP.POP.GROW");
        }

        region_code = sessionStorage.getItem("region_code");

        if(region_code === null){
            region_code ="WLD";
            sessionStorage.setItem("region_code","WLD");
        }


        //default vis
        smallMultiplesKey(dataset,country_metadata,aggregate_data,default_code,region_code,series_metadata,container); // 2015 always NA, mss vermelden of niet visualiseren

        keys = getAllCodes(dataset);

        var dropdown_series = d3.select(container).select("#keySelector").append("select")
                            .attr("name", "key_list")
                            .on("change", function(){   sessionStorage.setItem("series_code",this.value);
                                                        d3.select(container).select("#vis").selectAll("svg").remove();
                                                        d3.select(container).select("#info").selectAll("svg").remove();
                                                        d3.select(container).select("#legend").selectAll("text").remove();
                                                        d3.select(container).select("#legend").selectAll("svg").remove();
                                                        smallMultiplesKey(dataset,country_metadata,aggregate_data,this.value,sessionStorage.getItem("region_code"),series_metadata,container); });

        var options_series = dropdown_series.selectAll("option")
                        .data(keys)
                        .enter()
                        .append("option")
                        .property("selected",function(d){ return ((d.series_code === default_code) ? "selected" : "");});

        options_series.text(function(d){ return d.series_name; })
                .attr("value", function (d){ return d.series_code; });

        regions = getAllRegions(aggregate_data);

        var dropdown_region = d3.select(container).select("#keySelector").append("select")
                            .attr("name", "key_list")
                            .on("change", function(){   sessionStorage.setItem("region_code",this.value);
                                                        d3.select(container).select("#vis").selectAll("svg").remove();
                                                        d3.select(container).select("#info").selectAll("svg").remove();
                                                        d3.select(container).select("#legend").selectAll("text").remove();
                                                        d3.select(container).select("#legend").selectAll("svg").remove();
                                                        smallMultiplesKey(dataset,country_metadata,aggregate_data,sessionStorage.getItem("series_code"),this.value,series_metadata,container); });

        var options_region = dropdown_region.selectAll("option")
                        .data(regions)
                        .enter()
                        .append("option")
                        .property("selected",function(d){ return ((d.region_code === region_code) ? "selected" : "");});

        options_region.text(function(d){ return d.region_name; })
                .attr("value", function (d){ return d.region_code; });
    }



    function smallMultiplesKey(data,country_metadata,aggregate_data,series,region,series_metadata,container){
        var color = d3.scale.category10();

        var dataset = filterDataSeriesRegion(getDataSeries(data,series),country_metadata,series,region);

        var world_data = getDataCountry(getDataSeries(aggregate_data,series),"WLD");

        var region_data =  getDataCountry(aggregate_data, region);
        var region_series_data = ((region == "WLD")? [null] : getDataSeries(region_data,series));

        for(var i=0;i<dataset.length;i++){
            smallMultiplesChart(dataset[i],world_data[0],region_series_data[0],container,color(i%10),dataset);
        }

        drawLegend(region, container);

        drawInfo(series, series_metadata, container);
    }

    function drawInfo(series, series_metadata, container){
        var series_metadata_data = getLongDefinition(series_metadata, series);

        var div = d3.select(container).append("div")   
            .attr("class", "infotip")               
            .style("opacity", 0);

        var svg = d3.select(container).select("#info").append("svg")
        .attr("width", 20)
        .attr("height", 20);

        node = svg.append("g")
        .on("mouseover", function (){
                div.transition()
                    .duration(200)
                    .style("opacity", 0.9)
                    .style("background", "gray");
                div.html(function () { return series_metadata_data[0].Long_Definition})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY + 18) + "px");
            })
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });
        node.append("circle")
            .attr("r",9)
            .attr("cx", 10)
            .attr("cy", 10)
            .style("fill", "white")
            .style("stroke", "#b6b6b6");          
       node.append("text").attr("x", 6,5).attr("y", 15).style("fill", "#b6b6b6").text("?");
    }

    function drawLegend(region,container){

        var legend = d3.select(container).select("#legend");
        var lineWidth = 30;
        var lineHeight = 10;
        var margin = 2;

        for(var i=1; i<=3; i++){
            if (i == 1) {
                var color = "steelblue";
                var text = "Country";
            } else if (i == 2){
                var color = "orange";
                var text = "Region";
            } else if (i == 3){
                var color = "crimson";
                var text = "World";
            }

            if (region == "WLD" && i == 2) {

            } else {
                var svg = legend.append("svg").attr("width", lineWidth).attr("height", lineHeight);
                svg.append("line").attr("x1",margin).attr("x2", lineWidth-margin).attr("y1",lineHeight/2).attr("y2",lineHeight/2).attr("stroke-width", 2).attr("stroke", color);
                svg.append("circle").attr("r", 3).attr("cx", lineWidth/2).attr("cy", lineHeight/2).style("fill", color);
                legend.append("text").text(text);
            }
        }
    }

    function getAllYears(data){
        result = []
        for(var i = 0;i<data.length;i++){
            for(var j =0;j<data[i].years.length;j++){
                result.push(data[i].years[j])
            }
        }

        return result;
    }

    function smallMultiplesChart(dataset,world_series_data,region_series_data,container,color,alldata){

        var all_country_data = getAllYears(alldata);

        var data = dataset.years;
        var world_data = world_series_data.years;
        
        if(region_series_data != null){
            var region_data = region_series_data.years;
            var allData = all_country_data.concat(region_data,world_data)
        }else{
            var allData = all_country_data.concat(world_data)
        }

        var formatTime = d3.time.format("%Y");

        var margin = {top: 15, right: 15, bottom: 20, left: 30},
            width = 450 - margin.left - margin.right,
            height = 180 - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain(d3.extent(data,function(d){ return d.year;}))
            .range([margin.left, width-margin.right]);

        if(dataset.series_code=="SP.POP.TOTL"){
            var y = d3.scale.log()
                .domain([1,d3.max(allData,function(d){return d.value;})])
                .base(10)
                .range([height-margin.bottom, margin.top]);

            var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .tickFormat(function (d) {
                return y.tickFormat(4,d3.format("s"))(d);
            });

            var value_format = d3.format(".4s");
            

        }else{
            var y = d3.scale.linear()
                .domain(d3.extent(allData,function(d){ return (isNaN(d.value)||d.value=="")?0:d.value;}))
                .range([height-margin.bottom, margin.top]);

            var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

            if(dataset.series_name.indexOf("%") != (-1)){
                var value_format = function(d){return d3.format(".2%")(d/100);};
            }else{
                var value_format = d3.format(".2f");
            }


        }

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var line = d3.svg.line()
            .x(function(d) {return x(d.year); })
            .y(function(d) {return (isNaN(d.value)||d.value=="")?(dataset.series_code=="SP.POP.TOTL"?y(1):y(0)):y(d.value); });  

        var svg = d3.select(container).select("#vis").append("svg")
            .attr("id", dataset.country_code)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .on("click", function(){
                sessionStorage.setItem("country_code",dataset.country_code);
                sessionStorage.setItem("compare_code","None")
                window.location="country_overview.html";
                })
            .style("cursor","pointer")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
        // Define the div for the tooltip
        var div = d3.select(container).append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0);

        svg.append("path")
            .datum(world_data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke","crimson");

        if(region_series_data != null){
            svg.append("path")
                .datum(region_data)
                .attr("class", "line")
                .attr("d", line)
                .style("stroke","orange");
        }

        svg.append("path")
            .datum(data)
            .attr("class","line")
            .attr("d", line)
            .style("stroke","steelblue");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0,"+ (dataset.series_code=="SP.POP.TOTL"?y(1):y(0)) +")")
            .call(xAxis)
            .selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "translate(0,"+((height-margin.bottom)-(dataset.series_code=="SP.POP.TOTL"?y(1):y(0))) +")rotate(-65)");

        svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + margin.left + ",0)")
            .call(yAxis);

        svg.append("text")
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + (width/2) + ",5)")
            .text(dataset.country_name);

        svg.selectAll("dot")    
            .data(world_data)         
            .enter().append("circle")                               
            .attr("r", 3)       
            .attr("cx", function(d) { return x(d.year); })       
            .attr("cy", function(d) { return (isNaN(d.value)||d.value=="")?(dataset.series_code=="SP.POP.TOTL"?y(1):y(0)):y(d.value); })
            .style("fill", function(d){ return (isNaN(d.value)||d.value=="")? "grey":"crimson";})
            .on("mouseover", function(d) {      
                div.transition()        
                    .duration(200)      
                    .style("opacity", .9)
                    .style("background","#B7384F");      
                div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " + value_format(d.value)));})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });

        if(region_series_data != null){
            svg.selectAll("dot")    
                .data(region_data)         
                .enter().append("circle")                               
                .attr("r", 3)       
                .attr("cx", function(d) { return x(d.year); })       
                .attr("cy", function(d) { return (isNaN(d.value)||d.value=="")?(dataset.series_code=="SP.POP.TOTL"?y(1):y(0)):y(d.value); })
                .style("fill", function(d){ return (isNaN(d.value)||d.value=="")? "grey":"orange";})
                .on("mouseover", function(d) {      
                    div.transition()        
                        .duration(200)      
                        .style("opacity", .9)
                        .style("background","#CC8433");      
                    div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " +value_format(d.value)));})
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");
                })                  
                .on("mouseout", function(d) {       
                    div.transition()        
                        .duration(500)      
                        .style("opacity", 0);
                });
        }

        svg.selectAll("dot")    
            .data(data)         
            .enter().append("circle")                               
            .attr("r", 3)       
            .attr("cx", function(d) { return x(d.year); })       
            .attr("cy", function(d) { return (isNaN(d.value)||d.value=="")?(dataset.series_code=="SP.POP.TOTL"?y(1):y(0)):y(d.value); })
            .style("fill", function(d){ return (isNaN(d.value)||d.value=="")? "grey":"steelblue";})
            .on("mouseover", function(d) {      
                div.transition()        
                    .duration(200)      
                    .style("opacity", .9)
                    .style("background","#335E82");      
                div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " + value_format(d.value)));})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
                    
            })                  
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });

    }

    </script>


</body>
</html>
