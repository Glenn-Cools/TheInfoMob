<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
  <title>Small multiples</title>
<style>
#container {
    position: absolute;
    top: 50px;
    text-align: center;
    padding: 10px;
}

.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.axis text{
    display : none;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 8px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 1px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 6px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.area {
  fill: lightsteelblue;
  stroke-width: 0;
}



</style>
</head>

<body>
	<h1 id="output">
	</h1>
    <div id="container">
    </div>

    <div id="FlowChart"></div>

	<script type="text/javascript" src="d3/d3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

	<script> 

    d3.csv("/TheInfoMob/Data/Data.csv", function(d){
        return {
            series_name : d["Series Name"],
            series_code : d["Series Code"],
            country_name : d["Country Name"],
            country_code : d["Country Code"],
            years : [
                {year:"1960" ,"value": +d["1960 [YR1960]"]},
                {year:"1961" ,"value": +d["1961 [YR1961]"]},
                {year:"1962" ,"value": +d["1962 [YR1962]"]},
                {year:"1963" ,"value": +d["1963 [YR1963]"]},
                {year:"1964" ,"value": +d["1964 [YR1964]"]},
                {year:"1965" ,"value": +d["1965 [YR1965]"]},
                {year:"1966" ,"value": +d["1966 [YR1966]"]},
                {year:"1967" ,"value": +d["1967 [YR1967]"]},
                {year:"1968" ,"value": +d["1968 [YR1968]"]},
                {year:"1969" ,"value": +d["1969 [YR1969]"]},
                {year:"1970" ,"value": +d["1970 [YR1970]"]},
                {year:"1971" ,"value": +d["1971 [YR1971]"]},
                {year:"1972" ,"value": +d["1972 [YR1972]"]},
                {year:"1973" ,"value": +d["1973 [YR1973]"]},
                {year:"1974" ,"value": +d["1974 [YR1974]"]},
                {year:"1975" ,"value": +d["1975 [YR1975]"]},
                {year:"1976" ,"value": +d["1976 [YR1976]"]},
                {year:"1977" ,"value": +d["1977 [YR1977]"]},
                {year:"1978" ,"value": +d["1978 [YR1978]"]},
                {year:"1979" ,"value": +d["1979 [YR1979]"]},
                {year:"1980" ,"value": +d["1980 [YR1980]"]},
                {year:"1981" ,"value": +d["1981 [YR1981]"]},
                {year:"1982" ,"value": +d["1982 [YR1982]"]},
                {year:"1983" ,"value": +d["1983 [YR1983]"]},
                {year:"1984" ,"value": +d["1984 [YR1984]"]},
                {year:"1985" ,"value": +d["1985 [YR1985]"]},
                {year:"1986" ,"value": +d["1986 [YR1986]"]},
                {year:"1987" ,"value": +d["1987 [YR1987]"]},
                {year:"1988" ,"value": +d["1988 [YR1988]"]},
                {year:"1989" ,"value": +d["1989 [YR1989]"]},
                {year:"1990" ,"value": +d["1990 [YR1990]"]},
                {year:"1991" ,"value": +d["1991 [YR1991]"]},
                {year:"1992" ,"value": +d["1992 [YR1992]"]},
                {year:"1993" ,"value": +d["1993 [YR1993]"]},
                {year:"1994" ,"value": +d["1994 [YR1994]"]},
                {year:"1995" ,"value": +d["1995 [YR1995]"]},
                {year:"1996" ,"value": +d["1996 [YR1996]"]},
                {year:"1997" ,"value": +d["1997 [YR1997]"]},
                {year:"1998" ,"value": +d["1998 [YR1998]"]},
                {year:"1999" ,"value": +d["1999 [YR1999]"]},
                {year:"2000" ,"value": +d["2000 [YR2000]"]},
                {year:"2001" ,"value": +d["2001 [YR2001]"]},
                {year:"2002" ,"value": +d["2002 [YR2002]"]},
                {year:"2003" ,"value": +d["2003 [YR2003]"]},
                {year:"2004" ,"value": +d["2004 [YR2004]"]},
                {year:"2005" ,"value": +d["2005 [YR2005]"]},
                {year:"2006" ,"value": +d["2006 [YR2006]"]},
                {year:"2007" ,"value": +d["2007 [YR2007]"]},
                {year:"2008" ,"value": +d["2008 [YR2008]"]},
                {year:"2009" ,"value": +d["2009 [YR2009]"]},
                {year:"2010" ,"value": +d["2010 [YR2010]"]},
                {year:"2011" ,"value": +d["2011 [YR2011]"]},
                {year:"2012" ,"value": +d["2012 [YR2012]"]},
                {year:"2013" ,"value": +d["2013 [YR2013]"]},
                {year:"2014" ,"value": +d["2014 [YR2014]"]},
                {year:"2015" ,"value": +d["2015 [YR2015]"]}
            ]
        }
    },function(data){
        //console.log(data)
        // ALL CODE INVOLVING THIS DATA COMES HERE
        smallMultiples(data,"SP.POP.GROW");
    })

    //OWN TOOLTIP, look for bookmark and d3.mouse()

    

    function getData(dataset,key){
        result =[]
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].series_code == key){
                result.push(dataset[i]);
            }
        }
        return result;
    }

    /*
    function compareCountries(data, country1, country2){
        for(var i=0;i<data.length;i++){
            if(data[i].country == country1 || data[i].country == country2){
                console.log(data[i]);
            }     
        } 
    }*/

    function smallMultiples(data,key){

        var color = d3.scale.category10();

        var dataset = getData(data,key);

        for(var i=0;i<dataset.length;i++){
            smallMultiplesChart(dataset[i].years,"#container",color(i%10));
        }
    }

    function smallMultiplesChart(data,container,color){

        var parseDate = d3.time.format("%Y").parse;

        /*var checkData = function(value){
            return !(isNaN(value));
        }*/

        for(var k=0;k<data.length;k++){
            data[k].year = parseDate(data[k].year);
        }


        var margin = {top: 5, right: 5, bottom: 5, left: 5},
            width = 120 - margin.left - margin.right,
            height = 50 - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain(d3.extent(data,function(d){ return d.year;}))
            .range([0, width]);

        var y = d3.scale.linear()
            .domain(d3.extent(data,function(d){ return d.value;}))
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .tickSize(0)
            .orient("bottom");

        var line = d3.svg.line()
            .x(function(d) {return x(d.year); })
            .y(function(d) {return y(d.value); });

        var area = d3.svg.area()
            .x(function(d) { return x(d.year); })
            .y0(y(0))
            .y1(function(d) { return y(d.value); });


        /*var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-5, 0])
            .html(function(d) { return "<strong>Song:</strong> <span style='color:orange'>" + title + " - " + artist + "</span>";
                })
            .style("top", 100 +"px")
            .style("left", 200 +"px")*/

        var svg = d3.select(container).append("svg")
            .attr("id", data.country_code)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            //.on('mouseover', function(d) {tip.show(d, document.getElementById(id)); })
            //.on('mouseout', tip.hide)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            

        //svg.call(tip);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0,"+ y(0) +")")
            .call(xAxis);

        svg.append("path")
            .datum(data)
            .attr("class", "area")
            .attr("d", area);

        svg.append("path")
            .datum(data)
            .attr("class","line")
            .attr("d", line);

        /*svg.selectAll(".bar")
            .data(listenersFlow)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.week); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { if(checkListenersData(d.listeners)){
                return y(d.listeners);
            }else{return 0;}
            })
            .attr("height", function(d) {if(checkListenersData(d.listeners)){
                return height - y(d.listeners);}
                else{return height;} })
            .style("fill",function(d){if(checkListenersData(d.listeners)){return color;}
                                    else{return 'white'}});*/
    }


    function flowChartListeners(title, artist){
        listenersFlow = getListenersFlowForSong(dataList,title,artist);

        var margin = {top: 20, right: 80, bottom: 20, left: 80},
            width = 960 - margin.left - margin.right,
            height = 100 - margin.top - margin.bottom;

        var x = d3.scale.ordinal()
            .domain(listenersFlow.map(function(d) { return mapWeekIndexToDate(d.week);}))
            .rangeRoundBands([0, width], .1);

        var yMax = d3.max(listenersFlow, function(d){return d.listeners;})

        var y = d3.scale.linear()
            .domain([0, 1.5*yMax])
            .range([height, 0]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left")
            .ticks(6, "%");

        var checkListenersData = function(listeners){
            return listeners != null;
        }

        var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d) { if(checkListenersData(d.listeners)){
                return "<strong>Listeners:</strong> <span style='color:orange'>" + d.listeners + "</span>";
            } else{
                return "<strong>Listeners:</strong> <span style='color:orange'>" + "NO DATA" + "</span>";
            }
                })

        var svg = d3.select("#FlowChart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        svg.call(tip);

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Listeners");

        svg.append("text")
            .attr("x", (width / 2))             
            .attr("y", margin.top/2)
            .attr("text-anchor", "middle")  
            .style("font-size", "16px")
            .text(title + " - " + artist);

        svg.selectAll(".bar")
            .data(listenersFlow)
            .enter().append("rect")
            .attr("class", "bar")
            .attr("x", function(d) { return x(d.week); })
            .attr("width", x.rangeBand())
            .attr("y", function(d) { if(checkListenersData(d.listeners)){
                return y(d.listeners);
            }else{return y(yMax);}
            })
            .attr("height", function(d) {if(checkListenersData(d.listeners)){
                return height - y(d.listeners);}
                else{return height- y(yMax);} })
            .style("fill",function(d){if(checkListenersData(d.listeners)){return "#006d2c";
            }else{return "#ffffff";}
            })
            .on('mouseover', function(d){
                d3.select(this)
                .attr("height",function(d) {if(checkListenersData(d.listeners)){
                        return height - y(d.listeners);}
                    else{return height-y(yMax);} })
                .style("fill", "#009CCC");
                tip.show(d);
                
            })
            .on('mouseout', function(d){
                d3.select(this)
                .attr("height",function(d) {if(checkListenersData(d.listeners)){
                        return height - y(d.listeners);}
                    else{return height-y(yMax);} })
                .style("fill",function(d){if(checkListenersData(d.listeners)){return "#006d2c";
                    }else{return "#ffffff";}
                });
                tip.hide(d);
            });
    }

    </script>


</body>
</html>
