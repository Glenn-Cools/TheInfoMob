<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
    <link href="css/bootstrap.min.css" rel="stylesheet">
  <title>Country Overview</title>
<style>

#defaultText{
    position: relative;
    top: 100px;
    text-align: center;
    font: 30px sans-serif;
}

#vis{
    position: absolute;
    top: 50px;
    left: 20px;
}

#countrySelector{
    position: fixed;
    left: 20px;
    background: white;
    z-index: 1
}

.axis {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

div.tooltip {   
    position: absolute;         
    text-align: center;
    color: white;
    height: 32px;                
    padding: 2px;               
    font: 12px sans-serif;      
    background: #335E82; 
    border: 0px;        
    border-radius: 8px;         
    pointer-events: none;           
}

.line {
  fill: none;
  stroke-width: 1.5px;
}


</style>
</head>

<body>
 
    <div id="defaultText" align="center">The data is being loaded.<br>Please wait.</div>
    <div id="countryOverview1">
        <div id="countrySelector"></div>
        <div id="vis"></div>
    </div>
    <div id="smallMultiples2">
        <div id="countrySelector"></div>
        <div id="vis"></div>
    </div>

    

	<script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="js/lodash.min.js"></script>

	<script> 

    d3.csv("/TheInfoMob/Data/Country_Metadata.csv", function(error, Country_Metadata){
        d3.csv("/TheInfoMob/Data/Aggregate_Data.csv",function(d){

                var parseDate = d3.time.format("%Y").parse;

                return {
                    series_name : d["Series Name"],
                    series_code : d["Series Code"],
                    country_name : d["Country Name"],
                    country_code : d["Country Code"],
                    years : [
                    {year:parseDate("1960") ,"value": +d["1960 [YR1960]"]},
                    {year:parseDate("1961") ,"value": +d["1961 [YR1961]"]},
                    {year:parseDate("1962") ,"value": +d["1962 [YR1962]"]},
                    {year:parseDate("1963") ,"value": +d["1963 [YR1963]"]},
                    {year:parseDate("1964") ,"value": +d["1964 [YR1964]"]},
                    {year:parseDate("1965") ,"value": +d["1965 [YR1965]"]},
                    {year:parseDate("1966") ,"value": +d["1966 [YR1966]"]},
                    {year:parseDate("1967") ,"value": +d["1967 [YR1967]"]},
                    {year:parseDate("1968") ,"value": +d["1968 [YR1968]"]},
                    {year:parseDate("1969") ,"value": +d["1969 [YR1969]"]},
                    {year:parseDate("1970") ,"value": +d["1970 [YR1970]"]},
                    {year:parseDate("1971") ,"value": +d["1971 [YR1971]"]},
                    {year:parseDate("1972") ,"value": +d["1972 [YR1972]"]},
                    {year:parseDate("1973") ,"value": +d["1973 [YR1973]"]},
                    {year:parseDate("1974") ,"value": +d["1974 [YR1974]"]},
                    {year:parseDate("1975") ,"value": +d["1975 [YR1975]"]},
                    {year:parseDate("1976") ,"value": +d["1976 [YR1976]"]},
                    {year:parseDate("1977") ,"value": +d["1977 [YR1977]"]},
                    {year:parseDate("1978") ,"value": +d["1978 [YR1978]"]},
                    {year:parseDate("1979") ,"value": +d["1979 [YR1979]"]},
                    {year:parseDate("1980") ,"value": +d["1980 [YR1980]"]},
                    {year:parseDate("1981") ,"value": +d["1981 [YR1981]"]},
                    {year:parseDate("1982") ,"value": +d["1982 [YR1982]"]},
                    {year:parseDate("1983") ,"value": +d["1983 [YR1983]"]},
                    {year:parseDate("1984") ,"value": +d["1984 [YR1984]"]},
                    {year:parseDate("1985") ,"value": +d["1985 [YR1985]"]},
                    {year:parseDate("1986") ,"value": +d["1986 [YR1986]"]},
                    {year:parseDate("1987") ,"value": +d["1987 [YR1987]"]},
                    {year:parseDate("1988") ,"value": +d["1988 [YR1988]"]},
                    {year:parseDate("1989") ,"value": +d["1989 [YR1989]"]},
                    {year:parseDate("1990") ,"value": +d["1990 [YR1990]"]},
                    {year:parseDate("1991") ,"value": +d["1991 [YR1991]"]},
                    {year:parseDate("1992") ,"value": +d["1992 [YR1992]"]},
                    {year:parseDate("1993") ,"value": +d["1993 [YR1993]"]},
                    {year:parseDate("1994") ,"value": +d["1994 [YR1994]"]},
                    {year:parseDate("1995") ,"value": +d["1995 [YR1995]"]},
                    {year:parseDate("1996") ,"value": +d["1996 [YR1996]"]},
                    {year:parseDate("1997") ,"value": +d["1997 [YR1997]"]},
                    {year:parseDate("1998") ,"value": +d["1998 [YR1998]"]},
                    {year:parseDate("1999") ,"value": +d["1999 [YR1999]"]},
                    {year:parseDate("2000") ,"value": +d["2000 [YR2000]"]},
                    {year:parseDate("2001") ,"value": +d["2001 [YR2001]"]},
                    {year:parseDate("2002") ,"value": +d["2002 [YR2002]"]},
                    {year:parseDate("2003") ,"value": +d["2003 [YR2003]"]},
                    {year:parseDate("2004") ,"value": +d["2004 [YR2004]"]},
                    {year:parseDate("2005") ,"value": +d["2005 [YR2005]"]},
                    {year:parseDate("2006") ,"value": +d["2006 [YR2006]"]},
                    {year:parseDate("2007") ,"value": +d["2007 [YR2007]"]},
                    {year:parseDate("2008") ,"value": +d["2008 [YR2008]"]},
                    {year:parseDate("2009") ,"value": +d["2009 [YR2009]"]},
                    {year:parseDate("2010") ,"value": +d["2010 [YR2010]"]},
                    {year:parseDate("2011") ,"value": +d["2011 [YR2011]"]},
                    {year:parseDate("2012") ,"value": +d["2012 [YR2012]"]},
                    {year:parseDate("2013") ,"value": +d["2013 [YR2013]"]},
                    {year:parseDate("2014") ,"value": +d["2014 [YR2014]"]},
                    {year:parseDate("2015") ,"value": +d["2015 [YR2015]"]}
                    ]
                }
            },function(Aggregate_Data){
                d3.csv("/TheInfoMob/Data/Data.csv", function(d){

                    var parseDate = d3.time.format("%Y").parse;

                    return {
                        series_name : d["Series Name"],
                        series_code : d["Series Code"],
                        country_name : d["Country Name"],
                        country_code : d["Country Code"],
                        years : [
                        {year:parseDate("1960") ,"value": +d["1960 [YR1960]"]},
                        {year:parseDate("1961") ,"value": +d["1961 [YR1961]"]},
                        {year:parseDate("1962") ,"value": +d["1962 [YR1962]"]},
                        {year:parseDate("1963") ,"value": +d["1963 [YR1963]"]},
                        {year:parseDate("1964") ,"value": +d["1964 [YR1964]"]},
                        {year:parseDate("1965") ,"value": +d["1965 [YR1965]"]},
                        {year:parseDate("1966") ,"value": +d["1966 [YR1966]"]},
                        {year:parseDate("1967") ,"value": +d["1967 [YR1967]"]},
                        {year:parseDate("1968") ,"value": +d["1968 [YR1968]"]},
                        {year:parseDate("1969") ,"value": +d["1969 [YR1969]"]},
                        {year:parseDate("1970") ,"value": +d["1970 [YR1970]"]},
                        {year:parseDate("1971") ,"value": +d["1971 [YR1971]"]},
                        {year:parseDate("1972") ,"value": +d["1972 [YR1972]"]},
                        {year:parseDate("1973") ,"value": +d["1973 [YR1973]"]},
                        {year:parseDate("1974") ,"value": +d["1974 [YR1974]"]},
                        {year:parseDate("1975") ,"value": +d["1975 [YR1975]"]},
                        {year:parseDate("1976") ,"value": +d["1976 [YR1976]"]},
                        {year:parseDate("1977") ,"value": +d["1977 [YR1977]"]},
                        {year:parseDate("1978") ,"value": +d["1978 [YR1978]"]},
                        {year:parseDate("1979") ,"value": +d["1979 [YR1979]"]},
                        {year:parseDate("1980") ,"value": +d["1980 [YR1980]"]},
                        {year:parseDate("1981") ,"value": +d["1981 [YR1981]"]},
                        {year:parseDate("1982") ,"value": +d["1982 [YR1982]"]},
                        {year:parseDate("1983") ,"value": +d["1983 [YR1983]"]},
                        {year:parseDate("1984") ,"value": +d["1984 [YR1984]"]},
                        {year:parseDate("1985") ,"value": +d["1985 [YR1985]"]},
                        {year:parseDate("1986") ,"value": +d["1986 [YR1986]"]},
                        {year:parseDate("1987") ,"value": +d["1987 [YR1987]"]},
                        {year:parseDate("1988") ,"value": +d["1988 [YR1988]"]},
                        {year:parseDate("1989") ,"value": +d["1989 [YR1989]"]},
                        {year:parseDate("1990") ,"value": +d["1990 [YR1990]"]},
                        {year:parseDate("1991") ,"value": +d["1991 [YR1991]"]},
                        {year:parseDate("1992") ,"value": +d["1992 [YR1992]"]},
                        {year:parseDate("1993") ,"value": +d["1993 [YR1993]"]},
                        {year:parseDate("1994") ,"value": +d["1994 [YR1994]"]},
                        {year:parseDate("1995") ,"value": +d["1995 [YR1995]"]},
                        {year:parseDate("1996") ,"value": +d["1996 [YR1996]"]},
                        {year:parseDate("1997") ,"value": +d["1997 [YR1997]"]},
                        {year:parseDate("1998") ,"value": +d["1998 [YR1998]"]},
                        {year:parseDate("1999") ,"value": +d["1999 [YR1999]"]},
                        {year:parseDate("2000") ,"value": +d["2000 [YR2000]"]},
                        {year:parseDate("2001") ,"value": +d["2001 [YR2001]"]},
                        {year:parseDate("2002") ,"value": +d["2002 [YR2002]"]},
                        {year:parseDate("2003") ,"value": +d["2003 [YR2003]"]},
                        {year:parseDate("2004") ,"value": +d["2004 [YR2004]"]},
                        {year:parseDate("2005") ,"value": +d["2005 [YR2005]"]},
                        {year:parseDate("2006") ,"value": +d["2006 [YR2006]"]},
                        {year:parseDate("2007") ,"value": +d["2007 [YR2007]"]},
                        {year:parseDate("2008") ,"value": +d["2008 [YR2008]"]},
                        {year:parseDate("2009") ,"value": +d["2009 [YR2009]"]},
                        {year:parseDate("2010") ,"value": +d["2010 [YR2010]"]},
                        {year:parseDate("2011") ,"value": +d["2011 [YR2011]"]},
                        {year:parseDate("2012") ,"value": +d["2012 [YR2012]"]},
                        {year:parseDate("2013") ,"value": +d["2013 [YR2013]"]},
                        {year:parseDate("2014") ,"value": +d["2014 [YR2014]"]},
                        {year:parseDate("2015") ,"value": +d["2015 [YR2015]"]}
                        ]
                    }
                },function(data){

                    //fix total pop for countries
                    for(var i=0;i<data.length;i++){
                        if(data[i].series_code=="SP.POP.TOTL"){
                            data[i].series_name = data[i].series_name +" (In thousands)";
                            var years = data[i].years;
                            for(var j=0;j<years.length;j++){
                                if(years[j].value != ""){
                                    years[j].value = years[j].value/1000;
                                }
                            }
                        }
                    }

                    //fix total pop for aggregates
                    for(var i=0;i<Aggregate_Data.length;i++){
                        if(Aggregate_Data[i].series_code=="SP.POP.TOTL"){
                            Aggregate_Data[i].series_name = Aggregate_Data[i].series_name +" (In thousands)";
                            var years = Aggregate_Data[i].years;
                            for(var j=0;j<years.length;j++){
                                if(years[j].value != ""){
                                    years[j].value = years[j].value/1000;
                                }
                            }
                        }
                    }

                    document.getElementById("defaultText").innerHTML = "";
                    // ALL CODE INVOLVING THIS DATA COMES HERE
                    createVisualisation(data,Country_Metadata,Aggregate_Data,"#countryOverview1");
                    //createVisualisation(data,"#smallMultiples2");
            
            })
        })
    })

    //OWN TOOLTIP, look for bookmark and d3.mouse()

    function getDataCountry(dataset,country_code){
        var result =[];
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].country_code == country_code){
                result.push(dataset[i]);
            } 
        }
        return result;
    }

    function getDataSeries(dataset,series_code){
        var result =[];
        for(var i=0; i<dataset.length;i++){
            if(dataset[i].series_code == series_code){
                result.push(dataset[i]);
            } 
        }
        return result;
    }

    function getAllCountries(dataset){

        var result = [];
        for(var i=0; i<(dataset.length);i++){
            if(dataset[i].series_code=="SP.POP.GROW"){
                result.push({country_name : dataset[i].country_name, country_code: dataset[i].country_code});
            }
        }
        return result;
    }

    function getRegionCode(country_metadata, country_code){
        for (var i=0; i<(country_metadata.length);i++){
            if (country_code==country_metadata[i].Country_Code){
                return country_metadata[i].Region_Code;
            }
        }
    }

    function createVisualisation(dataset,country_metadata,aggregate_data,container){

        default_code = sessionStorage.getItem("country_code");

        if(default_code === null){
            default_code ="BEL";
            sessionStorage.setItem("country_code","BEL");
        }

        //default vis
        CountryOverviewKey(dataset,country_metadata,aggregate_data,default_code,container); // 2015 always NA, mss vermelden of niet visualiseren

        keys = getAllCountries(dataset);

        var dropdown = d3.select(container).select("#countrySelector").append("select")
                            .attr("name", "key_list")
                            .on("change", function(){   sessionStorage.setItem("country_code",this.value);
                                                        d3.select(container).select("#vis").selectAll("svg").remove();
                                                        CountryOverviewKey(dataset,country_metadata,aggregate_data,this.value,container); });

        var options = dropdown.selectAll("option")
                        .data(keys)
                        .enter()
                        .append("option")
                        .property("selected",function(d){ return ((d.country_code === default_code) ? "selected" : "");});


        options.text(function(d){ return d.country_name; })
                .attr("value", function (d){ return d.country_code; });


    }

    function CountryOverviewKey(data,country_metadata,aggregate_data,key,container){

        //key is landscode

        var color = d3.scale.category10();

        var dataset = getDataCountry(data,key);

        var world_data = getDataCountry(aggregate_data,"WLD");

        var region = getRegionCode(country_metadata,key)

        var region_data = getDataCountry(aggregate_data, region);

        for(var i=0;i<dataset.length;i++){
            var region_series_data = getDataSeries(region_data,dataset[i].series_code);
            var world_series_data = getDataSeries(world_data,dataset[i].series_code);

            CountryOverviewChart(dataset[i],world_series_data[0],region_series_data[0],container,color(i%10));
        }
    }

    function CountryOverviewChart(dataset,world_series_data,region_series_data,container,color){

        var data = dataset.years;
        var region_data = region_series_data.years;
        var world_data = world_series_data.years;
        var allData = data.concat(region_data,world_data)

        var formatTime = d3.time.format("%Y");

        var margin = {top: 15, right: 15, bottom: 20, left: 30},
            width = 450 - margin.left - margin.right,
            height = 180 - margin.top - margin.bottom;

        var x = d3.time.scale()
            .domain(d3.extent(allData,function(d){ return d.year;}))
            .range([margin.left, width-margin.right]);

        var y = d3.scale.linear()
            .domain(d3.extent(allData,function(d){ return d.value;}))
            .range([height-margin.bottom, margin.top]);

        var xAxis = d3.svg.axis()
            .scale(x)
            .tickFormat(formatTime)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var line = d3.svg.line()
            .x(function(d) {return x(d.year); })
            .y(function(d) {return (isNaN(d.value)?y(0):y(d.value)); });  

        var svg = d3.select(container).select("#vis").append("svg")
            .attr("id", dataset.series_code)
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .on("click", function(){
                sessionStorage.setItem("series_code",dataset.series_code);
                window.location="small_multiples.html";
                })
            .style("cursor","pointer")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Define the div for the tooltip
        var div = d3.select(container).append("div")   
            .attr("class", "tooltip")               
            .style("opacity", 0);

        svg.append("path")
            .datum(world_data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke","crimson");

        svg.append("path")
            .datum(region_data)
            .attr("class", "line")
            .attr("d", line)
            .style("stroke","orange");

        svg.append("path")
            .datum(data)
            .attr("class","line")
            .attr("d", line)
            .style("stroke","steelblue");

        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0,"+ y(0) +")")
            .call(xAxis)
            .selectAll("text")  
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", ".15em")
                .attr("transform", "translate(0,"+((height-margin.bottom)-y(0)) +")rotate(-65)");

        svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(" + margin.left + ",0)")
            .call(yAxis);
    
        svg.append("text")
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + (width/2) + ",0)")
            .text(dataset.series_name);
        
        svg.selectAll("dot")    
            .data(world_data)         
            .enter().append("circle")                               
            .attr("r", 3)       
            .attr("cx", function(d) { return x(d.year); })       
            .attr("cy", function(d) { return(isNaN(d.value)?y(0):y(d.value)); })
            .style("fill", function(d){ return d.value != ""? "crimson":"grey";})
            .on("mouseover", function(d) {      
                div.transition()        
                    .duration(200)      
                    .style("opacity", .9);      
                div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " + d.value));})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });

        svg.selectAll("dot")    
            .data(region_data)         
            .enter().append("circle")                               
            .attr("r", 3)       
            .attr("cx", function(d) { return x(d.year); })       
            .attr("cy", function(d) { return(isNaN(d.value)?y(0):y(d.value)); })
            .style("fill", function(d){ return d.value != ""? "orange":"grey";})
            .on("mouseover", function(d) {      
                div.transition()        
                    .duration(200)      
                    .style("opacity", .9);      
                div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " + d.value));})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });

        svg.selectAll("dot")    
            .data(data)         
            .enter().append("circle")                               
            .attr("r", 3)       
            .attr("cx", function(d) { return x(d.year); })       
            .attr("cy", function(d) { return (isNaN(d.value)?y(0):y(d.value)); })
            .style("fill", function(d){ return d.value != ""? "steelblue":"grey";})
            .on("mouseover", function(d) {      
                div.transition()        
                    .duration(200)      
                    .style("opacity", .9);      
                div.html(function(){return ((isNaN(d.value)||d.value=="")?("Year: " + formatTime(d.year) + "<br/>"  + "NO DATA"):("Year: " + formatTime(d.year) + "<br/>"  + "Value: " + d.value));})
                    .style("left", (d3.event.pageX) + "px")     
                    .style("top", (d3.event.pageY - 28) + "px");
            })                  
            .on("mouseout", function(d) {       
                div.transition()        
                    .duration(500)      
                    .style("opacity", 0);
            });

            
    }

    </script>


</body>
</html>
